<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CKEditor 5 – balloon block editor build – development sample</title>
  <style>
    body {
      margin: 20px auto;
    }

    h1 {
      max-width: 870px;
      margin: 1em auto;
    }
  </style>
</head>
<body>

<h1>CKEditor 5 – balloon block editor build – development sample</h1>

<div id="editor">

</div>

<script src="../build/ckeditor.js"></script>
<script src="../build/translations/ja.js"></script>

<script>

	BalloonEditor.create( document.querySelector( '#editor' ) ).then( editor => {
		window.editor = editor;
		window.env = BalloonEditor.utils.env;
		console.log( window.editor.ui.componentFactory._components );
		window.editor.ui.componentFactory._components.get( 'gallery' ).callback().on( 'change:galleryIsOn', ( p1, p2, p3 ) => {
			console.log( 'gallery' );
			console.log( p1 );
			console.log( p2 );
			console.log( p3 );
		} );
		window.editor.ui.componentFactory._components.get( 'imagedelete' ).callback().on( 'change:deleteIsOn', ( p1, p2, p3 ) => {
			console.log( 'delete' );
		} );
		window.editor.ui.componentFactory._components.get( 'imagecrop' ).callback().on( 'change:cropIsOn', ( p1, p2, p3 ) => {
			console.log( 'crop' );
			BalloonEditor.utils.fetchLocalImage( editor.model.document.selection.getSelectedElement() )
				.then( ( data ) => {
					console.log( data );
				} )
				.catch( ( err ) => {
					console.log( err );
				} );
		} );
		editor.editing.view.document.on( 'delete', ( evInfo, event ) => {
			console.log( 'yes we can! before', event );
		} );
		editor.editing.view.document.on( 'clipboardInput', ( evInfo, event ) => {
			// insertNewLine(editor.model)
		} );
		editor.ui.componentFactory._components.get( 'beforeimginsert' ).callback()
			.on( 'change:beforeInsert', ( p1, p2, p3 ) => {
				console.log( 'before insert--- ', p3 );
			} );
		editor.ui.componentFactory._components.get( 'beforeimgdelete' ).callback()
			.on( 'change:beforeDelete', ( p1, p2, p3 ) => {
				console.log( 'before delete--- ', p3 );
			} );
		editor.model.schema.extend( 'image', {
			allowAttributes: ['data-uri', 'data-link', 'natural-height', 'natural-width', 'data-size']
		} );
		// data-link
		editor.conversion.for( 'upcast' ).attributeToAttribute( {
			view: 'data-link',
			model: 'data-link'
		} );
		editor.conversion.for( 'downcast' ).add( dispatcher => {
			dispatcher.on( 'attribute:data-link:image', ( evt, data, conversionApi ) => {
				if (!conversionApi.consumable.consume( data.item, evt.name )) {
					return;
				}
				const viewWriter = conversionApi.writer;
				const figure = conversionApi.mapper.toViewElement( data.item );
				const img = figure.getChild( 0 );
				if (data.attributeNewValue !== null) {
					viewWriter.setAttribute( 'data-link', data.attributeNewValue, img );
				} else {
					viewWriter.removeAttribute( 'data-link', img );
				}
			} );
		} );
		editor.plugins.get( 'FileRepository' ).loaders.on( 'add', ( evt, loader ) => {
			loader.on( 'change:uploaded', ( evt, name, uploadedPercent ) => {
				editor.model.change( writer => {
					const carretPosition = editor.model.document.selection.getLastPosition();
					if (carretPosition.nodeAfter && carretPosition.nodeAfter.name !== 'paragraph') {
						const pElement = writer.createElement( 'paragraph' );
						writer.insert( pElement, carretPosition );
					}
				} );
			} );
		} );
	} )
		.catch( error => {
			console.error( 'There was a problem initializing the editor.', error );
		} );
  function insertNewLine( model ) {
	  model.change( writer => {
		  const caretPosition = model.document.selection.getLastPosition();
		  if ( !caretPosition.nodeAfter || caretPosition.nodeAfter.name !== 'paragraph' ) {
			  const pElement = writer.createElement( 'paragraph' );
			  writer.insert( pElement, model.document.selection.getLastPosition() );
		  }
	  } );
  }
</script>
</body>
</html>
